version: 2.1
orbs:
  go: circleci/go@1.7.0
jobs:
  build:
    docker:
      - image: cimg/node:14.15.0-browsers
    steps:
      - go/install:
          version: 1.16.4

      - run:
          name: Install protoc
          command: |
            version=3.12.0
            archive=protoc-${version}-linux-x86_64.zip
            curl -O -L https://github.com/protocolbuffers/protobuf/releases/download/v${version}/${archive}
            sudo unzip -d '/usr/local' ${archive} 'bin/*' 'include/*'
            sudo chmod 755 /usr/local/bin/protoc
            rm ${archive}
            protoc --version

      - run:
          name: Install conformance-test-runner
          command: |
            version=22.3
            archive=conformance_test_runner-${version}-linux-x86_64.zip
            curl -O -L https://github.com/bufbuild/protobuf-conformance/releases/download/v${version}/${archive}
            unzip ${archive}
            # sudo cp libprotobuf.so.23 /usr/lib/
            sudo cp ./bin/conformance_test_runner /usr/bin/
            sudo chmod 755 /usr/bin/conformance_test_runner
            # rm libprotobuf.so.23
            rm -rf ./bin
            rm ${archive}


      # check out the code in the project directory
      - checkout

      - run: make
